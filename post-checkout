#!/usr/bin/env ruby

@from, @to, flag = ARGV
exit unless flag == '1' && @to != @from

def rollback(files)
  unless files.empty?
    `git checkout #{@from} #{files.join(' ')}`
    system "rake db:rollback STEP=#{files.count}"
    `git reset --hard`
  end
end

def migrate(files)
  system "rake db:migrate" unless files.empty?
end

rollbacks = []
migrations = []

`git diff --name-status #{@from} #{@to} db/migrate/`.split("\n").each do |line|
  status, file = line.split("\t")
  rollbacks <<= file if status == "D"
  migrations <<= file if status == "A"
end

puts "Migrating:  #{rollbacks.count} down, #{migrations.count} up"

rollback(rollbacks)
migrate(migrations)
